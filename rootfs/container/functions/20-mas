# SPDX-FileCopyrightText: Â© 2025 Nfrastack <code@nfrastack.com>
#
# SPDX-License-Identifier: MIT

mas_bootstrap_filesystem() {
    create_folder \
                "${CONFIG_PATH},\
                ${DATA_PATH},\
                ${LOG_PATH}" \
                "${MAS_USER}":"${MAS_GROUP}" 755

    create_logrotate mas "${LOG_PATH%/}"/*.log ${MAS_USER} "${MAS_GROUP}"
}

mas_generate_configuration() {
    #if [ "${SETUP_TYPE,,}" = "auto" ] ; then
    #    print_debug "[generate_configuration] Generating Configuration"
    #fi

    if [ ! -f "${CONFIG_PATH}/${CONFIG_FILE}" ]; then
        mas-cli config generate 2>/dev/null | silent sudo -u "${MAS_USER}" tee "${CONFIG_PATH%/}"/"${CONFIG_FILE}"
    fi

    sanity_db postgres
    export DB_STRING=${DB_STRING:-"postgres://${DB_USER}:${DB_PASS}@${DB_HOST}:${DB_PORT}/${DB_NAME}"}
    sudo -Eu "${MAS_USER}" yq -i '
                                    .database.uri = env(DB_STRING) |
                                    .database.max_connections = (env(DB_CONNECTIONS_MAX) | tonumber) |
                                    .database.min_connections = (env(DB_CONNECTIONS_MIN) | tonumber) |
                                    .database.connect_timeout = (env(DB_TIMEOUT_CONNECT) | tonumber) |
                                    .database.idle_timeout = (env(DB_TIMEOUT_IDLE) | tonumber) |
                                    .database.max_lifetime = (env(DB_LIFETIME_MAX) | tonumber)
                                ' "${CONFIG_PATH}/${CONFIG_FILE}"

    sanity_var MATRIX_HOMESERVER_TYPE "Homeserver Type"
    sanity_var MATRIX_HOMESERVER "Homeserver Information"
    sanity_var MATRIX_HOMESERVER_ENDPOINT "Endpoint URL"

    sudo -Eu "${MAS_USER}" yq -i '
                                    .matrix.kind = env(MATRIX_HOMESERVER_TYPE) |
                                    .matrix.homeserver = env(MATRIX_HOMESERVER) |
                                    .matrix.endpoint = env(MATRIX_HOMESERVER_ENDPOINT)
                                ' "${CONFIG_PATH}/${CONFIG_FILE}"

    if [ -n "${MATRIX_HOMESERVER_SECRET_FILE}" ]; then
        sudo -Eu "${MAS_USER}" yq -i '
                                        .matrix.secret_file = env(MATRIX_HOMESERVER_SECRET_FILE)
                                    ' "${CONFIG_PATH}/${CONFIG_FILE}"
    else
        sanity_var MATRIX_HOMESERVER_SECRET "Shared secret"
        sudo -Eu "${MAS_USER}" yq -i '
                                        .matrix.secret = env(MATRIX_HOMESERVER_SECRET)
                                    ' "${CONFIG_PATH}/${CONFIG_FILE}"
    fi

    sanity_var MAIL_FROM "Email From Address"
    sanity_var MAIL_REPLY_TO "Email Reply-To Address"
    sanity_var MAIL_TYPE "Email Transport (none, smtp)"
    sudo -Eu "${MAS_USER}" yq -i '
                                    .email.from = env(MAIL_FROM) |
                                    .email.reply_to = env(MAIL_REPLY_TO)
                                ' "${CONFIG_PATH}/${CONFIG_FILE}"
    case "${MAIL_TYPE}" in
        smtp )
            export MAIL_TRANSPORT="smtp"
            sanity_var MAIL_SMTP_MODE "SMTP Mode (plain, ssl, starttls)"
            sanity_var MAIL_SMTP_HOST "SMTP Hostname"
            sanity_var MAIL_SMTP_PORT "SMTP Port"
            sudo -Eu "${MAS_USER}" yq -i '
                                            .email.transport = env(MAIL_TRANSPORT)
                                            .email.mode = env(MAIL_SMTP_MODE)
                                            .email.hostname = env(MAIL_SMTP_HOST)
                                            .email.port = (env(MAIL_SMTP_HOST) | tonumber)
                                            .email.username = env(MAIL_SMTP_USER)
                                            .email.password = env(MAIL_SMTP_PASS)
                                        ' "${CONFIG_PATH}/${CONFIG_FILE}"
        ;;
        none )
            export MAIL_TRANSPORT="blackhole"
            sudo -Eu "${MAS_USER}" yq -i '
                                            .email.transport = env(MAIL_TRANSPORT)
                                        ' "${CONFIG_PATH}/${CONFIG_FILE}"

        ;;
    esac

    sanity_var MAS_URL "MAS Public URL"
    sanity_var OIDC_ISSUER_URL "OIDC Issuer URL"
    sudo -Eu "${MAS_USER}" yq -i '
                                    .http.public_base = strenv(MAS_URL) |
                                    .http.issuer = strenv(OIDC_ISSUER_URL)
                                 ' "${CONFIG_PATH}/${CONFIG_FILE}"

    sudo -Eu "${MAS_USER}" yq -i '
                                    .http.listeners = [
                                        {
                                            "name": env(LISTENER_PUBLIC_NAME),
                                            "resources": (env(LISTENER_PUBLIC_RESOURCES) | split(",") | map({"name": .})),
                                            "binds": [{ "host": strenv(LISTENER_PUBLIC_IP), "port": env(LISTENER_PUBLIC_PORT) }],
                                            "proxy_protocol": env(LISTENER_PUBLIC_PROXY_PROTOCOL)
                                        },
                                        {
                                            "name": env(LISTENER_INTERNAL_NAME),
                                            "resources": (env(LISTENER_INTERNAL_RESOURCES) | split(",") | map({"name": .})),
                                            "binds": [{ "host": strenv(LISTENER_INTERNAL_IP), "port": env(LISTENER_INTERNAL_PORT) }],
                                            "proxy_protocol": env(LISTENER_INTERNAL_PROXY_PROTOCOL)
                                        }
                                    ]
                                ' "${CONFIG_PATH}/${CONFIG_FILE}"

    ## TODO Multiple Provider Support
    ## This only supports my existing Provider LLNG
    ## Also need functionality to define additional claims and we able to supply custom k and v pairs see on_conflict and set_email_verification options below
    sudo -Eu "${MAS_USER}" yq -i '
                                    .upstream_oauth2.providers =
                                    [
                                      {
                                        "id": env(PROVIDER_ID),
                                        "human_name": env(PROVIDER_HUMAN_NAME),
                                        "issuer": strenv(PROVIDER_ISSUER),
                                        "client_id": strenv(PROVIDER_CLIENT_ID),
                                        "client_secret": strenv(PROVIDER_CLIENT_SECRET),
                                        "token_endpoint_auth_method": strenv(PROVIDER_TOKEN_ENDPOINT_AUTH_METHOD),
                                        "scope": strenv(PROVIDER_SCOPE),
                                        "discovery_mode": strenv(PROVIDER_DISCOVERY_MODE),
                                        "fetch_userinfo": env(PROVIDER_FETCH_USERINFO),
                                        "claims_imports": {
                                          "localpart": {
                                            "action": "require",
                                            "template": "{{ user.preferred_username }}",
                                            "on_conflict": "add"
                                          },
                                          "displayname": {
                                            "action": "suggest",
                                            "template": "{{ user.given_name }} {{ user.family_name }}"
                                          },
                                          "email": {
                                            "action": "suggest",
                                            "template": "{{ user.email }}",
                                            "set_email_verification": "always"
                                          }
                                        }
                                      }
                                    ]
                                 ' "${CONFIG_PATH}/${CONFIG_FILE}"



#account:
#  # Whether users are allowed to change their email addresses.
#  #
#  # Defaults to `true`.
#  email_change_allowed: true
#
#  # Whether users are allowed to change their display names
#  #
#  # Defaults to `true`.
#  # This should be in sync with the policy in the homeserver configuration.
#  displayname_change_allowed: true
#
#  # Whether to enable self-service password registration
#  #
#  # Defaults to `false`.
#  # This has no effect if password login is disabled.
#  password_registration_enabled: false
#
#  # Whether users are allowed to change their passwords
#  #
#  # Defaults to `true`.
#  # This has no effect if password login is disabled.
#  password_change_allowed: true
#
#  # Whether email-based password recovery is enabled
#  #
#  # Defaults to `false`.
#  # This has no effect if password login is disabled.
#  password_recovery_enabled: false
#
#  # Whether users are allowed to delete their own account
#  #
#  # Defaults to `true`.
#  account_deactivation_allowed: true
#
#  # Whether users can log in with their email address.
#  #
#  # Defaults to `false`.
#  # This has no effect if password login is disabled.
#  login_with_email_allowed: false
#
#  # Whether registration tokens are required for password registrations.
#  #
#  # Defaults to `false`.
#  #
#  # When enabled, users must provide a valid registration token during password
#  # registration. This has no effect if password registration is disabled.
#  registration_token_required: false    ## need to work on clients

#captcha:
#    # Which service to use for CAPTCHA protection. Set to `null` (or `~`) to disable CAPTCHA protection
#    service: ~
#
#    # Use Google reCAPTCHA v2
#    #service: recaptcha_v2
#    #site_key: "6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI"
#    #secret_key: "6LeIxAcTAAAAAGG"-vFI1TnRWxMZNFuojJ4WifJWe
#
#    # Use Cloudflare Turnstile
#    #service: cloudflare_turnstile
#    #site_key: "1x00000000000000000000AA"
#    #secret_key: "1x0000000000000000000000000000000AA"
#
#    # Use hCaptcha
#    #service: hcaptcha
#    #site_key: "10000000-ffff-ffff-ffff-000000000001"
#    #secret_key: "0x0000000000000000000000000000000000000000"

#policy:
#  # Path to the WASM module
#  # Default in Docker distribution: `/usr/local/share/mas-cli/policy.wasm`
#  # Default in pre-built binaries: `./share/policy.wasm`
#  # Default in locally-built binaries: `./policies/policy.wasm`
#  wasm_module: ./policies/policy.wasm
#  # Entrypoint to use when evaluating client registrations
#  client_registration_entrypoint: client_registration/violation
#  # Entrypoint to use when evaluating user registrations
#  register_entrypoint: register/violation
#  # Entrypoint to use when evaluating authorization grants
#  authorization_grant_entrypoint: authorization_grant/violation
#  # Entrypoint to use when changing password
#  password_entrypoint: password/violation
#  # Entrypoint to use when adding an email address
#  email_entrypoint: email/violation
#
#  # This data is being passed to the policy
#  data:
#    # Users which are allowed to ask for admin access. If possible, use the
#    # can_request_admin flag on users instead.
#    admin_users:
#      - person1
#      - person2
#
#    # Client IDs which are allowed to ask for admin access with a
#    # client_credentials grant
#    admin_clients:
#      - 01H8PKNWKKRPCBW4YGH1RWV279
#      - 01HWQCPA5KF10FNCETY9402WGF
#
#    # Dynamic Client Registration
#    client_registration:
#      # don't require URIs to be on the same host. default: false
#      allow_host_mismatch: false
#      # allow non-SSL and localhost URIs. default: false
#      allow_insecure_uris: false
#      # don't require clients to provide a client_uri. default: false
#      allow_missing_client_uri: false
#
#    # Restrictions on user registration
#    registration:
#      # If specified, the username (localpart) *must* match one of the allowed
#      # usernames. If unspecified, all usernames are allowed.
#      allowed_usernames:
#        # Exact usernames that are allowed
#        literals: ["alice", "bob"]
#        # Substrings that match allowed usernames
#        substrings: ["user"]
#        # Regular expressions that match allowed usernames
#        regexes: ["^[a-z]+$"]
#        # Prefixes that match allowed usernames
#        prefixes: ["user-"]
#        # Suffixes that match allowed usernames
#        suffixes: ["-corp"]
#      # If specified, the username (localpart) *must not* match one of the
#      # banned usernames. If unspecified, all usernames are allowed.
#      banned_usernames:
#        # Exact usernames that are banned
#        literals: ["admin", "root"]
#        # Substrings that match banned usernames
#        substrings: ["admin", "root"]
#        # Regular expressions that match banned usernames
#        regexes: ["^admin$", "^root$"]
#        # Prefixes that match banned usernames
#        prefixes: ["admin-", "root-"]
#        # Suffixes that match banned usernames
#        suffixes: ["-admin", "-root"]
#
#    # Restrict what email addresses can be added to a user
#    emails:
#      # If specified, the email address *must* match one of the allowed addresses.
#      # If unspecified, all email addresses are allowed.
#      allowed_addresses:
#        # Exact emails that are allowed
#        literals: ["alice@example.com", "bob@example.com"]
#        # Regular expressions that match allowed emails
#        regexes: ["@example\\.com$"]
#        # Suffixes that match allowed emails
#        suffixes: ["@example.com"]
#
#      # If specified, the email address *must not* match one of the banned addresses.
#      # If unspecified, all email addresses are allowed.
#      banned_addresses:
#        # Exact emails that are banned
#        literals: ["alice@evil.corp", "bob@evil.corp"]
#        # Emails that contains those substrings are banned
#        substrings: ["evil"]
#        # Regular expressions that match banned emails
#        regexes: ["@evil\\.corp$"]
#        # Suffixes that match banned emails
#        suffixes: ["@evil.corp"]
#        # Prefixes that match banned emails
#        prefixes: ["alice@"]
#
#    requester:
#      # List of IP addresses and CIDRs that are not allowed to register
#      banned_ips:
#        - 192.168.0.1
#        - 192.168.1.0/24
#        - fe80::/64
#
#      # User agent patterns that are not allowed to register
#      banned_user_agents:
#        literals: ["Pretend this is Real;"]
#        substrings: ["Chrome"]
#        regexes: ["Chrome 1.*;"]
#        prefixes: ["Mozilla/"]
#        suffixes: ["Safari/605.1.15"]
#

#rate_limiting:
#  # Limits how many account recovery attempts are allowed.
#  # These limits can protect against e-mail spam.
#  #
#  # Note: these limit also apply to recovery e-mail re-sends.
#  account_recovery:
#    # Controls how many account recovery attempts are permitted
#    # based on source IP address.
#    per_ip:
#      burst: 3
#      per_second: 0.0008
#
#    # Controls how many account recovery attempts are permitted
#    # based on the e-mail address that is being used for recovery.
#    per_address:
#      burst: 3
#      per_second: 0.0002
#
#  # Limits how many login attempts are allowed.
#  #
#  # Note: these limit also applies to password checks when a user attempts to
#  # change their own password.
#  login:
#    # Controls how many login attempts are permitted
#    # based on source IP address.
#    # This can protect against brute force login attempts.
#    per_ip:
#      burst: 3
#      per_second: 0.05
#
#    # Controls how many login attempts are permitted
#    # based on the account that is being attempted to be logged into.
#    # This can protect against a distributed brute force attack
#    # but should be set high enough to prevent someone's account being
#    # casually locked out.
#    per_account:
#      burst: 1800
#      per_second: 0.5
#
#  # Limits how many registrations attempts are allowed,
#  # based on source IP address.
#  # This limit can protect against e-mail spam and against people registering too many accounts.
#  registration:
#    burst: 3
#    per_second: 0.0008
#

#telemetry:
#  tracing:
#    # List of propagators to use for extracting and injecting trace contexts
#    propagators:
#      # Propagate according to the W3C Trace Context specification
#      - tracecontext
#      # Propagate according to the W3C Baggage specification
#      - baggage
#      # Propagate trace context with Jaeger compatible headers
#      - jaeger
#
#    # The default: don't export traces
#    exporter: none
#
#    # Export traces to an OTLP-compatible endpoint
#    #exporter: otlp
#    #endpoint: https://localhost:4318
#
#  metrics:
#    # The default: don't export metrics
#    exporter: none
#
#    # Export metrics to an OTLP-compatible endpoint
#    #exporter: otlp
#    #endpoint: https://localhost:4317
#
#    # Export metrics by exposing a Prometheus endpoint
#    # This requires mounting the `prometheus` resource to an HTTP listener
#    #exporter: prometheus
#
#  sentry:
#    # DSN to use for sending errors and crashes to Sentry
#    dsn: https://public@host:port/1
#

#branding:
#  # A human-readable name. Defaults to the server's address.
#  #service_name:
#
#  # Link to a privacy policy, displayed in the footer of web pages and
#  # emails. It is also advertised to clients through the `op_policy_uri`
#  # OIDC provider metadata.
#  #policy_uri:
#
#  # Link to a terms of service document, displayed in the footer of web
#  # pages and emails. It is also advertised to clients through the
#  # `op_tos_uri` OIDC provider metadata.
#  #
#  # This also adds a mandatory checkbox during registration. The value of
#  # this config item will be stored in the `user_terms` table to indicate
#  # which ToS document the user accepted. Note that currently changing this
#  # value will not force existing users to re-accept terms.
#  #tos_uri:
#
#  # Legal imprint, displayed in the footer in the footer of web pages and emails.
#  #imprint:
#
#  # Logo displayed in some web pages.
#  #logo_uri:
#

#passwords:
#  # Whether to enable the password database.
#  # If disabled, users will only be able to log in using upstream OIDC providers
#  enabled: true
#
#  # Minimum complexity required for passwords, estimated by the zxcvbn algorithm
#  # Must be between 0 and 4, default is 3
#  # See https://github.com/dropbox/zxcvbn#usage for more information
#  minimum_complexity: 3
#
#  # List of password hashing schemes being used
#  # /!\ Only change this if you know what you're doing
#  # TODO: document this section better
#  schemes:
#    - version: 1
#      algorithm: argon2id
#upstream_oauth2:
#  providers:
#    - # A unique identifier for the provider
#      # Must be a valid ULID
#      id: 01HFVBY12TMNTYTBV8W921M5FA
#
#      # The issuer URL, which will be used to discover the provider's configuration.
#      # If discovery is enabled, this *must* exactly match the `issuer` field
#      # advertised in `<issuer>/.well-known/openid-configuration`.
#      # It must be set if OIDC discovery is enabled (which is the default).
#      #issuer: https://example.com/
#
#      # A human-readable name for the provider,
#      # which will be displayed on the login page
#      #human_name: Example
#
#      # A brand identifier for the provider, which will be used to display a logo
#      # on the login page. Values supported by the default template are:
#      #  - `apple`
#      #  - `google`
#      #  - `facebook`
#      #  - `github`
#      #  - `gitlab`
#      #  - `twitter`
#      #brand_name: google
#
#      # The client ID to use to authenticate to the provider
#      client_id: mas-fb3f0c09c4c23de4
#
#      # The client secret to use to authenticate to the provider
#      # This is only used by the `client_secret_post`, `client_secret_basic`
#      # and `client_secret_jwk` authentication methods
#      #client_secret: f4f6bb68a0269264877e9cb23b1856ab
#
#      # Which authentication method to use to authenticate to the provider
#      # Supported methods are:
#      #   - `none`
#      #   - `client_secret_basic`
#      #   - `client_secret_post`
#      #   - `client_secret_jwt`
#      #   - `private_key_jwt` (using the keys defined in the `secrets.keys` section)
#      #   - `sign_in_with_apple` (a special authentication method for Sign-in with Apple)
#      token_endpoint_auth_method: client_secret_post
#
#      # Additional paramaters for the `sign_in_with_apple` authentication method
#      # See https://www.oauth.com/oauth2-servers/pkce/authorization-code-flow-with-pkce/
#      #sign_in_with_apple:
#      #  private_key: |
#      #    -----BEGIN PRIVATE KEY-----
#      #    ...
#      #    -----END PRIVATE KEY-----
#      #  team_id: "<team-id>"
#      #  key_id: "<key-id>"
#
#      # Which signing algorithm to use to sign the authentication request when using
#      # the `private_key_jwt` or the `client_secret_jwt` authentication methods
#      #token_endpoint_auth_signing_alg: RS256
#
#      # The scopes to request from the provider
#      # In most cases, it should always include `openid` scope
#      scope: "openid email profile"
#
#      # How the provider configuration and endpoints should be discovered
#      # Possible values are:
#      #  - `oidc`: discover the provider through OIDC discovery,
#      #     with strict metadata validation (default)
#      #  - `insecure`: discover through OIDC discovery, but skip metadata validation
#      #  - `disabled`: don't discover the provider and use the endpoints below
#      #discovery_mode: oidc
#
#      # Whether PKCE should be used during the authorization code flow.
#      # Possible values are:
#      #  - `auto`: use PKCE if the provider supports it (default)
#      #    Determined through discovery, and disabled if discovery is disabled
#      #  - `always`: always use PKCE (with the S256 method)
#      #  - `never`: never use PKCE
#      #pkce_method: auto
#
#      # Whether to fetch user claims from the userinfo endpoint
#      # This is disabled by default, as most providers will return the necessary
#      # claims in the `id_token`
#      #fetch_userinfo: true
#
#      # If set, ask for a signed response on the userinfo endpoint, and validate
#      # the response uses the given algorithm
#      #userinfo_endpoint_auth_signing_alg: RS256
#
#      # The userinfo endpoint
#      # This takes precedence over the discovery mechanism
#      #userinfo_endpoint: https://example.com/oauth2/userinfo
#
#      # The provider authorization endpoint
#      # This takes precedence over the discovery mechanism
#      #authorization_endpoint: https://example.com/oauth2/authorize
#
#      # The provider token endpoint
#      # This takes precedence over the discovery mechanism
#      #token_endpoint: https://example.com/oauth2/token
#
#      # The provider JWKS URI
#      # This takes precedence over the discovery mechanism
#      #jwks_uri: https://example.com/oauth2/keys
#
#      # The response mode we ask the provider to use for the callback
#      # Possible values are:
#      #  - `query`: The provider will send the response as a query string in the
#      # URL search parameters. This is the default.
#      #  - `form_post`: The provider will send the response as a POST request with
#      # the response parameters in the request body
#      #response_mode: query
#
#      # Additional parameters to include in the authorization request
#      #additional_authorization_parameters:
#      #  foo: "bar"
#
#      # Whether the `login_hint` should be forwarded to the provider in the
#      # authorization request.
#      #forward_login_hint: false
#
#      # What to do when receiving an OIDC Backchannel logout request.
#      # Possible values are:
#      #  - `do_nothing` (default): do nothing, other than validating and logging the request
#      #  - `logout_browser_only`: Only log out the MAS 'browser session' started by this OIDC session
#      #  - `logout_all`: Log out all sessions started by this OIDC session, including MAS 'browser sessions' and client sessions
#      #on_backchannel_logout: do_nothing
#
#      # How user attributes should be mapped
#      #
#      # Most of those attributes have two main properties:
#      #   - `action`: what to do with the attribute. Possible values are:
#      #      - `ignore`: ignore the attribute
#      #      - `suggest`: suggest the attribute to the user, but let them opt out
#      #      - `force`: always import the attribute, and don't fail if it's missing
#      #      - `require`: always import the attribute, and fail if it's missing
#      #   - `template`: a Jinja2 template used to generate the value. In this template,
#      #      the `user` variable is available, which contains the user's attributes
#      #      retrieved from the `id_token` given by the upstream provider and/or through
#      #      the userinfo endpoint.
#      #
#      # Each attribute has a default template which follows the well-known OIDC claims.
#      #
#      claims_imports:
#        # The subject is an internal identifier used to link the
#        # user's provider identity to local accounts.
#        # By default it uses the `sub` claim as per the OIDC spec,
#        # which should fit most use cases.
#        subject:
#          #template: "{{ user.sub }}"
#
#        # The localpart is the local part of the user's Matrix ID.
#        # For example, on the `example.com` server, if the localpart is `alice`,
#        #  the user's Matrix ID will be `@alice:example.com`.
#        localpart:
#          #action: force
#          #template: "{{ user.preferred_username }}"
#
#          # How to handle when localpart already exists.
#          # Possible values are (default: fail):
#          # - `add` : Adds the upstream account link to the existing user, regardless of whether there is an existing link or not.
#          # - `fail` : Fails the upstream OAuth 2.0 login.
#          #on_conflict: fail
#
#        # The display name is the user's display name.
#        displayname:
#          #action: suggest
#          #template: "{{ user.name }}"
#
#        # An email address to import.
#        email:
#          #action: suggest
#          #template: "{{ user.email }}"
#
#          # Whether the email address must be marked as verified.
#          # Possible values are:
#          #  - `import`: mark the email address as verified if the upstream provider
#          #     has marked it as verified, using the `email_verified` claim.
#          #     This is the default.
#          #   - `always`: mark the email address as verified
#          #   - `never`: mark the email address as not verified
#          #set_email_verification: import
#
#        # An account name, for display purposes only
#        # This helps end user identify what account they are using
#        account_name:
#          #template: "@{{ user.preferred_username }}"
#
    #oidc
    #secrets
    #passwords
    #account
    #captcha
    #telemetry
    #upstream_oauth2  -- probably this needs to be loaded with multiple configs


    ## Add secrets configuration
    #yq -i '
    #    .secrets.encryption = "default_encryption_key" |
    #    .secrets.keys = []
    #' "${CONFIG_PATH}/${CONFIG_FILE}"


    #yq -i '
    #    .passwords.enabled = true |
    #    .passwords.schemes = [
    #        { version: 1, algorithm: "bcrypt" },
    #        { version: 2, algorithm: "argon2id" }
    #    ] |
    #    .passwords.minimum_complexity = 3
    #' "${CONFIG_PATH}/${CONFIG_FILE}"

}